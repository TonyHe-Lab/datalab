---
title: "Story 1.2: Windows Host Postgres Configuration (pg_hba.conf & Firewall)"
epic: 1
story: 2
status: Draft
---

## Story

**As a** developer/ops engineer,
**I want** clear, reproducible instructions to configure Postgres on the Windows host (pg_hba.conf, listen_addresses, and firewall rules),
**so that** WSL-based developers and CI systems can connect reliably to the Postgres instance running on the Windows host.

## Acceptance Criteria

1. Documented steps to configure `postgresql.conf` and `pg_hba.conf` for accepting connections from WSL IP ranges and localhost as needed.
2. Firewall rules documented to permit Postgres TCP access on the configured port, with least-privilege guidance and rollback commands.
3. Guidance for secure credential handling (do not store plaintext credentials in repo; use `.env` or OS-level secrets) and recommended TLS usage if applicable.
4. A verification checklist that demonstrates a successful connection from a WSL instance to the Windows-host Postgres (psql connect example and a small Python connectivity test snippet).
5. Notes calling out platform-specific caveats, e.g., Docker Desktop/WSL network differences, and references to Story 1.1 for WSL setup validation.

## Dev Notes

Previous Story Insights:
- Story 1.1 prepares WSL environment; coordinate to ensure verification scripts align. [Source: docs/stories/1.1.WSL-Python-Node-Setup.md]

Configuration Guidance:
- Edit `postgresql.conf` to set `listen_addresses` appropriately (e.g., '*' or specific IPs) and confirm `port` setting. [Source: docs/prd_shards/05-epics.md#Epic-1]
- Modify `pg_hba.conf` to allow connections from WSL network ranges with appropriate auth method (md5 or scram-sha-256), and include example lines with host, database, user, address, method. [Source: docs/prd_shards/05-epics.md#Story-1.2]

Security / Secrets Handling:
- Do not commit database passwords. Recommend `.env` usage and include `.env` in `.gitignore`. Reference project security shard for secrets handling best practices. [Source: docs/prd_shards/12-security.md]

Testing / Verification:
- Provide `dev/verify_postgres_connection.py` (tiny script using psycopg[binary] or psycopg2) that reads connection info from env and exits 0 on success. Include `psql` command examples for manual verification. [Source: docs/architecture/testing-strategy.md (if present)]

Platform Notes / Caveats:
- Document differences when Postgres runs under Docker vs native Windows service. If Docker is used, include guidance for published ports and container network settings.
- If Windows Defender or corporate firewall policies block changes, include remediation guidance and point to IT escalation steps.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1) — Document `postgresql.conf` and `pg_hba.conf` changes
  - [ ] Draft `docs/setup/postgres-windows.md` with exact file locations, sample configuration snippets, and comments explaining each field.
  - [ ] Provide example `pg_hba.conf` lines for common cases: WSL local network, specific developer IPs, CI host.

Example `pg_hba.conf` lines (place in `C:\Program Files\PostgreSQL\data\pg_hba.conf` or container equivalent):

```
# Allow local connections
local   all             all                                     peer
# Allow WSL subnet range (example 172.22.0.0/16) using scram-sha-256
host    all             all             172.22.0.0/16          scram-sha-256
# Allow specific developer IP
host    all             all             203.0.113.45/32        md5
```

- [ ] Task 2 (AC: 2) — Firewall rule instructions and rollback
  - [ ] Add PowerShell/CMD examples to add/remove Windows Firewall rules for Postgres port (default 5432). Include Group Policy notes for corporate-managed machines.

PowerShell examples:

```powershell
# Add inbound rule to allow Postgres on 5432
New-NetFirewallRule -DisplayName "Allow Postgres" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow

# Remove rule (rollback)
Remove-NetFirewallRule -DisplayName "Allow Postgres"
```

- [ ] Task 4 (AC: 4) — Verification scripts and examples
  - [ ] Create `dev/verify_postgres_connection.py` reading env vars and attempting a connect; exit 0 on success.

- [ ] Task 2 (AC: 2) — Firewall rule instructions and rollback
  - [ ] Add PowerShell/CMD examples to add/remove Windows Firewall rules for Postgres port (default 5432). Include Group Policy notes for corporate-managed machines.

- [ ] Task 3 (AC: 3) — Secrets handling & TLS guidance
  - [ ] Reference `docs/prd_shards/12-security.md` and add concrete recommendations for `.env` usage and TLS enabling if Postgres listens on non-local interfaces.

- [ ] Task 4 (AC: 4) — Verification scripts and examples
  - [ ] Create `dev/verify_postgres_connection.py` reading env vars and attempting a connect; exit 0 on success.
  - [ ] Add `docs/setup/postgres-windows.md` section with `psql` example and troubleshooting tips.

- [ ] Task 5 (AC: 5) — Cross-link with Story 1.1 and CI
  - [ ] Ensure `dev/verify_env.sh` from Story 1.1 includes the Postgres connectivity test or reference this script.
  - [ ] Add a short GitHub Actions snippet suggestion to run connectivity test in a secure manner (secrets populated via repo secrets).

## Testing

- Verification focuses on connectivity checks (psql and small Python script). Unit tests not required. Ensure CI step honors secrets via repository secrets and does not echo credentials in logs.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Dev Agent Record

*To be populated by the development agent during implementation.*

## QA Results

*To be populated by QA agent.*
