---
title: "Story 1.2: Windows Host Postgres Configuration (pg_hba.conf & Firewall)"
epic: 1
story: 2
status: Ready for Done
---

## Story

**As a** developer/ops engineer,
**I want** clear, reproducible instructions to configure Postgres on the Windows host (pg_hba.conf, listen_addresses, and firewall rules),
**so that** WSL-based developers and CI systems can connect reliably to the Postgres instance running on the Windows host.

## Acceptance Criteria

1. Documented steps to configure `postgresql.conf` and `pg_hba.conf` for accepting connections from WSL IP ranges and localhost as needed.
2. Firewall rules documented to permit Postgres TCP access on the configured port, with least-privilege guidance and rollback commands.
3. Guidance for secure credential handling (do not store plaintext credentials in repo; use `.env` or OS-level secrets) and recommended TLS usage if applicable.
4. A verification checklist that demonstrates a successful connection from a WSL instance to the Windows-host Postgres (psql connect example and a small Python connectivity test snippet).
5. Notes calling out platform-specific caveats, e.g., Docker Desktop/WSL network differences, and references to Story 1.1 for WSL setup validation.

## Dev Notes

Previous Story Insights:
- Story 1.1 prepares WSL environment; coordinate to ensure verification scripts align. [Source: docs/stories/1.1.WSL-Python-Node-Setup.md]

Configuration Guidance:
- Edit `postgresql.conf` to set `listen_addresses` appropriately (e.g., '*' or specific IPs) and confirm `port` setting. [Source: docs/prd_shards/05-epics.md#Epic-1]
- Modify `pg_hba.conf` to allow connections from WSL network ranges with appropriate auth method (md5 or scram-sha-256), and include example lines with host, database, user, address, method. [Source: docs/prd_shards/05-epics.md#Story-1.2]

Security / Secrets Handling:
- Do not commit database passwords. Recommend `.env` usage and include `.env` in `.gitignore`. Reference project security shard for secrets handling best practices. [Source: docs/prd_shards/12-security.md]

Testing / Verification:
- Provide `dev/verify_postgres_connection.py` (tiny script using psycopg2-binary) that reads connection info from env and exits 0 on success. Include `psql` command examples for manual verification. [Source: docs/architecture/testing-strategy.md (if present)]

Platform Notes / Caveats:
- Document differences when Postgres runs under Docker vs native Windows service. If Docker is used, include guidance for published ports and container network settings.
- If Windows Defender or corporate firewall policies block changes, include remediation guidance and point to IT escalation steps.

## Tasks / Subtasks

- [x] Task 1 (AC: 1) — Document `postgresql.conf` and `pg_hba.conf` changes
  - [x] Draft `docs/setup/postgres-windows.md` with exact file locations, sample configuration snippets, and comments explaining each field.
  - [x] Provide example `pg_hba.conf` lines for common cases: WSL local network, specific developer IPs, CI host.

Example `pg_hba.conf` lines (place in `C:\Program Files\PostgreSQL\data\pg_hba.conf` or container equivalent):

```
# Allow local connections
local   all             all                                     peer
# Allow WSL subnet range (example 172.22.0.0/16) using scram-sha-256
host    all             all             172.22.0.0/16          scram-sha-256
# Allow specific developer IP
host    all             all             203.0.113.45/32        md5
```

- [x] Task 2 (AC: 2) — Firewall rule instructions and rollback
  - [x] Add PowerShell/CMD examples to add/remove Windows Firewall rules for Postgres port (default 5432). Include Group Policy notes for corporate-managed machines.

PowerShell examples:

```powershell
# Add inbound rule to allow Postgres on 5432
New-NetFirewallRule -DisplayName "Allow Postgres" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow

# Remove rule (rollback)
Remove-NetFirewallRule -DisplayName "Allow Postgres"
```

- [x] Task 3 (AC: 3) — Secrets handling & TLS guidance
  - [x] Reference `docs/prd_shards/12-security.md` and add concrete recommendations for `.env` usage and TLS enabling if Postgres listens on non-local interfaces.

- [x] Task 4 (AC: 4) — Verification scripts and examples
  - [x] Create `dev/verify_postgres_connection.py` reading env vars and attempting a connect; exit 0 on success.
  - [x] Add `docs/setup/postgres-windows.md` section with `psql` example and troubleshooting tips.

- [x] Task 5 (AC: 5) — Cross-link with Story 1.1 and CI
  - [x] Ensure `dev/verify_env.sh` from Story 1.1 includes the Postgres connectivity test or reference this script.
  - [x] Add a short GitHub Actions snippet suggestion to run connectivity test in a secure manner (secrets populated via repo secrets).

## Testing

- Verification focuses on connectivity checks (psql and small Python script). Unit tests not required. Ensure CI step honors secrets via repository secrets and does not echo credentials in logs.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|

## Dev Agent Record

*To be populated by the development agent during implementation.*

## QA Results

Summary:

- Gate decision: PASS — all acceptance criteria satisfied with comprehensive documentation and verification scripts.
- Rationale: All tasks have been completed, including creation of detailed Windows-host Postgres configuration documentation, firewall rule examples, security guidance, and integration with Story 1.1 verification scripts.

Findings (high level):

1) Coverage: Acceptance Criteria AC-1..AC-5 are fully implemented — PASS.
2) Implementation Status: All tasks in Tasks/Subtasks section are now marked as complete ([x]) — PASS.
3) Artifacts Created: Key artifacts created:
   - `docs/setup/postgres-windows.md` with comprehensive configuration instructions
   - `dev/verify_postgres_connection.py` enhanced with proper exit codes and error handling
   - PowerShell firewall rule examples with rollback instructions
   - Security guidance including `.env` usage and TLS recommendations — PASS.
4) Integration with Story 1.1: `dev/verify_env.sh` properly references and uses `dev/verify_postgres_connection.py` — PASS.
5) Security Guidance: Comprehensive security section in documentation, including credential handling and TLS recommendations — PASS.

Remediations Applied:

- ✅ Created `docs/setup/postgres-windows.md` with detailed Windows-host Postgres configuration.
- ✅ Enhanced `dev/verify_postgres_connection.py` with proper exit codes (including auth failure detection).
- ✅ Added PowerShell/CMD firewall rule examples with rollback instructions.
- ✅ Updated `dev/verify_env.sh` to properly reference and use Postgres verification script.
- ✅ Added comprehensive security guidance including `.env` usage and TLS recommendations.

Verification Checklist (executed):

- [x] Verify `docs/setup/postgres-windows.md` exists and contains clear, step-by-step instructions for pg_hba.conf and firewall configuration.
- [x] PowerShell firewall commands documented with rollback instructions.
- [x] `dev/verify_postgres_connection.py` runs with appropriate environment variables and provides proper exit codes.
- [x] `dev/verify_env.sh` from Story 1.1 successfully invokes the Postgres verification script.
- [x] Security guidance includes `.env` usage and TLS recommendations.

Decision and next steps:

- Decision: PASS — the story is fully implemented with all required artifacts. Documentation is comprehensive, verification scripts are functional, and integration with Story 1.1 is complete.
- Next steps: Merge the story. Ensure repository secrets are configured for CI verification, and developers follow the documented procedures for Windows-host Postgres configuration.

QA Agent: Quinn (Test Architect)
Date: 2025-12-27
