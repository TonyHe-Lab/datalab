---
title: "Story 2.3: Azure OpenAI Integration & PII Scrubbing Logic"
epic: 2
story: 3
status: Approved
---

## Story

**As a** system architect,
**I want** secure integration with Azure OpenAI for text analysis with PII scrubbing,
**so that** medical work orders can be processed safely while protecting patient privacy.

## Acceptance Criteria

AC-1: Azure OpenAI client implementation
- Validation steps: Client can authenticate with Azure OpenAI using API key
- Pass condition: Successful completion of test API calls to GPT-4o and embedding models

AC-2: PII detection and scrubbing
- Validation steps: Text preprocessing identifies and removes HIPAA-sensitive information
- Pass condition: PII detection accuracy > 95% on test dataset, scrubbed text contains no identifiable patient data

AC-3: Structured data extraction prompt engineering
- Validation steps: Prompt templates extract 5-dimensional data (component, fault, cause, summary, resolution_steps)
- Pass condition: AI returns valid JSON matching Pydantic schemas from Story 2.2

AC-4: Embedding generation for semantic search
- Validation steps: Text embeddings generated using text-embedding-3-small model
- Pass condition: Embeddings are 1536-dimensional vectors stored in semantic_embeddings table

AC-5: Rate limiting and cost control
- Validation steps: Implementation respects Azure OpenAI rate limits, tracks token usage
- Pass condition: No rate limit errors in production, cost monitoring alerts configured

AC-6: Error handling and fallback mechanisms
- Validation steps: Graceful degradation when Azure OpenAI is unavailable
- Pass condition: System continues operating with reduced functionality, errors are logged and monitored

## 验收测量方法
- 测量方法: 为每个接受准则定义可量化的测试（例如：API 调用成功/失败率、PII 检测 precision/recall、嵌入向量维度与一致性检查）。
- 测试数据来源: 使用 `tests/fixtures/` 中的合成医疗文本（包含插入的 PII 类型示例）与团队提供的脱敏样本。PII 相关测试必须使用合成或脱敏数据。
- 验收阈值与度量:
  - AC-1 (Azure 客户端): 使用测试 endpoint 完成至少 10 次请求（chat+embedding），成功率 >= 99%，平均延迟在可接受范围内（根据部署目标设定）。
  - AC-2 (PII 检测): 在指定测试集上，检测 precision 和 recall 均应 >= 0.95 或按团队同意的替代指标（需在 Dev Notes 中记录评估方法与数据集来源）。
  - AC-3 (结构化提取): 对于 500 条示例文本，AI 输出通过 Story 2.2 的 Pydantic schema 验证的通过率 >= 95%。
  - AC-4 (嵌入生成): 生成的向量维度为 1536，存储后可被检索并用于相似性查询；在小规模相似性回归测试中结果符合预期。
  - AC-5 (限流与成本): 在限流策略下无未处理的 429 错误，且 token 使用计费与预期相符（误差 < 10%）。
  - AC-6 (错误回退): 在 Azure OpenAI 不可用时，启用规则化回退路径并在预定时间窗口内恢复，恢复成功率 >= 95%。
- 验证位置: `tests/ai/` 的单元与集成测试；PII 性能基线与评估报告放在 `tests/fixtures/` 与 `docs/` 下的审计报告。

## Dev Notes

### Previous Story Insights
- Story 2.1 provides data pipeline
- Story 2.2 provides Pydantic schemas for validation
- Database schema supports vector embeddings

### Data Models
From architecture.md and Story 2.2:
- AIExtractedData schema for structured output
- maintenance_logs table for raw text storage
- semantic_embeddings table for vector storage

### API Specifications
Azure OpenAI REST API endpoints:
- Chat completions: /openai/deployments/{deployment}/chat/completions
- Embeddings: /openai/deployments/{deployment}/embeddings

Required environment variables:
- AZURE_OPENAI_ENDPOINT
- AZURE_OPENAI_API_KEY
- AZURE_OPENAI_DEPLOYMENT (for chat)
- AZURE_OPENAI_EMBEDDING_DEPLOYMENT

### File Locations
Based on EPIC2_STARTUP_PLAN.md project structure:
- `src/ai/openai_client.py` - Azure OpenAI client wrapper
- `src/ai/pii_scrubber.py` - PII detection and scrubbing
- `src/ai/text_analyzer.py` - Main text analysis orchestration
- `src/ai/prompt_templates.py` - Prompt engineering templates
- `config/ai_config.yaml` - AI configuration
- `tests/ai/test_openai_client.py` - Client tests
- `tests/ai/test_pii_scrubber.py` - PII scrubbing tests

### Testing Requirements
From architecture.md security constraints:
- PII compliance is critical (HIPAA requirements)
- Test with synthetic medical data containing PII
- Verify no PII leaks in logs or error messages
- Mock Azure OpenAI API for testing

### Technical Constraints
- Use official Azure OpenAI Python SDK
- Implement request batching for efficiency
- Support both streaming and non-streaming responses
- Cache embeddings to reduce API calls
- Comply with Azure rate limits and quotas

## Tasks / Subtasks

- [ ] Task 1 (AC: 1) - Azure OpenAI client setup
  - [ ] Install azure-openai SDK
  - [ ] Create AzureOpenAIClient class with authentication
  - [ ] Implement chat completion method
  - [ ] Implement embedding generation method

- [ ] Task 2 (AC: 2) - PII scrubbing implementation
  - [ ] Research HIPAA-sensitive data patterns
  - [ ] Implement regex-based PII detection
  - [ ] Add medical terminology detection
  - [ ] Create PII scrubbing function with redaction/replacement
  - [ ] Test with synthetic medical data

- [ ] Task 3 (AC: 3) - Prompt engineering
  - [ ] Design prompt for 5-dimensional extraction
  - [ ] Create JSON schema validation in prompt
  - [ ] Implement few-shot learning examples
  - [ ] Add language detection and handling
  - [ ] Test prompt with sample maintenance logs

- [ ] Task 4 (AC: 4) - Embedding pipeline
  - [ ] Configure text-embedding-3-small model
  - [ ] Implement batch embedding generation
  - [ ] Create embedding storage in database
  - [ ] Add embedding cache layer

- [ ] Task 5 (AC: 5) - Rate limiting and monitoring
  - [ ] Implement token counting
  - [ ] Add rate limit handling with exponential backoff
  - [ ] Create cost tracking metrics
  - [ ] Set up alerts for high usage

- [ ] Task 6 (AC: 6) - Error handling and testing
  - [ ] Implement circuit breaker pattern
  - [ ] Add fallback to rule-based extraction
  - [ ] Create comprehensive test suite
  - [ ] Add integration tests with mocked API

## Testing

### Test File Location
- `tests/ai/test_openai_client.py` - Azure OpenAI client tests
- `tests/ai/test_pii_scrubber.py` - PII detection tests
- `tests/ai/test_text_analyzer.py` - Integration tests
- `tests/ai/test_prompts.py` - Prompt engineering tests

### Test Standards
- Use pytest with pytest-asyncio
- Mock all external API calls
- Test with synthetic data containing PII
- Verify no PII in logs or test output
- Test error scenarios and fallbacks

### Testing Frameworks and Patterns
- unittest.mock for Azure OpenAI API
- pytest fixtures for test data
- parameterized tests for different PII patterns
- snapshot testing for prompt templates

### Specific Testing Requirements
- PII detection accuracy tests
- Prompt effectiveness evaluation
- Embedding quality assessment
- Rate limit handling tests
- Cost estimation validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Initial story creation | Scrum Master |
