---
title: "Story 3.3: RAG Chat Endpoint Implementation"
epic: 3
story: 3
status: approved
---

## Story

**As a** maintenance engineer,
**I want** a RAG (Retrieval-Augmented Generation) chat endpoint,
**so that** I can get AI-generated diagnostic suggestions based on similar historical cases.

## Acceptance Criteria

AC-1: Context retrieval from search results
- Validation steps: Retrieve top N similar cases from hybrid search for context
- Pass condition: Context includes relevant historical cases with metadata

AC-2: Prompt engineering for medical diagnostics
- Validation steps: Create structured prompts combining query and retrieved context
- Pass condition: Prompts generate coherent diagnostic suggestions

AC-3: Azure OpenAI integration for generation
- Validation steps: Call Azure OpenAI API with RAG context
- Pass condition: AI generates relevant diagnostic advice based on context

AC-4: Chat API endpoint
- Validation steps: Create RESTful API endpoint for RAG chat
- Pass condition: API accepts diagnostic queries and returns AI-generated suggestions

AC-5: Response formatting and safety
- Validation steps: Format AI responses with structured output and safety checks
- Pass condition: Responses are well-formatted and include source attribution

## Tasks / Subtasks

- [ ] Task 1: Context retrieval service (AC: 1)
  - [ ] Integrate with hybrid search from Story 3.2
  - [ ] Create context retrieval and formatting logic
  - [ ] Add context relevance filtering
  - [ ] Implement context token management

- [ ] Task 2: Prompt engineering (AC: 2)
  - [ ] Design medical diagnostic prompt templates
  - [ ] Create context injection patterns
  - [ ] Implement prompt validation and sanitization
  - [ ] Add prompt versioning and testing

- [ ] Task 3: Azure OpenAI integration (AC: 3)
  - [ ] Configure Azure OpenAI client for chat completion
  - [ ] Implement RAG context injection
  - [ ] Add response streaming support
  - [ ] Create error handling and retry logic

- [ ] Task 4: Chat API endpoint (AC: 4)
  - [ ] Create `/api/chat` endpoint with request validation
  - [ ] Implement chat service orchestration
  - [ ] Add conversation history support
  - [ ] Create response serialization

- [ ] Task 5: Response formatting and safety (AC: 5)
  - [ ] Implement structured response formatting
  - [ ] Add source attribution to retrieved cases
  - [ ] Create safety filters for medical advice
  - [ ] Add response validation and sanitization

- [ ] Task 6: Testing and validation (AC: 1,2,3,4,5)
  - [ ] Create unit tests for prompt engineering
  - [ ] Create integration tests for chat endpoint
  - [ ] Test with realistic medical diagnostic scenarios
  - [ ] Validate response quality and safety

## Dev Notes

### Previous Story Insights
- Story 3.2: Hybrid search implementation for retrieving similar cases [Source: docs/stories/3.2.Hybrid-Search-Implementation.md]
- Story 2.3: Azure OpenAI integration patterns and configuration [Source: docs/stories/2.3.Azure-OpenAI-Integration-PII-Scrubbing.md]
- Story 2.2: Pydantic schemas for structured data [Source: docs/stories/2.2.Pydantic-Schema-Definition.md]

### Data Models
From architecture.md data model section:
- `ai_extracted_data` table contains structured diagnostic information [Source: docs/architecture.md#5-数据模型-data-model]
- `notification_text` table contains original work order text [Source: docs/architecture.md#5-数据模型-data-model]
- `semantic_embeddings` table for retrieving similar cases [Source: docs/architecture.md#5-数据模型-data-model]
- Resolution steps structure defined in Pydantic schemas [Source: docs/stories/2.2.Pydantic-Schema-Definition.md]

### API Specifications
From architecture.md component architecture:
- RAG chat endpoint for diagnostic assistance [Source: docs/architecture.md#31-核心服务-running-in-wsl-2]
- Azure OpenAI GPT-4o for generation [Source: docs/architecture.md#1-架构概览-executive-summary]
- Top 5 similar cases for RAG context [Source: docs/prd.md#25-智能问答与看板-rag--analytics]
- Structured output with summary and resolution steps [Source: docs/stories/2.2.Pydantic-Schema-Definition.md]

### File Locations
Based on project structure:
- `src/backend/services/chat_service.py` - RAG chat service implementation
- `src/backend/services/rag_context.py` - Context retrieval and formatting
- `src/backend/services/prompt_engineer.py` - Prompt engineering module
- `src/backend/api/chat.py` - Chat API endpoints
- `src/backend/core/response_formatter.py` - Response formatting
- `tests/backend/services/test_chat_service.py` - Chat service tests
- `tests/backend/api/test_chat.py` - Chat API tests

### Testing Requirements
From architecture.md testing strategy:
- Unit tests for prompt engineering
- Integration tests for RAG chat endpoint
- Medical terminology validation tests
- Safety and compliance tests for medical advice
- Response quality evaluation tests

### Technical Constraints
- Azure OpenAI GPT-4o for generation [Source: docs/architecture.md#1-架构概览-executive-summary]
- Top 5 similar cases for context (configurable) [Source: docs/prd.md#25-智能问答与看板-rag--analytics]
- Structured output with medical diagnostic format [Source: docs/stories/2.2.Pydantic-Schema-Definition.md]
- Context window management for token limits
- Safety filters for medical advice compliance

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-28 | 1.0 | Initial story creation | Scrum Master |
