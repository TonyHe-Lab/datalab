---
title: "Story 3.4: Analytics SQL Views & Endpoints (MTBF/Pareto)"
epic: 3
story: 4
status: approved
---

## Story

**As a** maintenance manager,
**I want** analytics SQL views and endpoints for MTBF and Pareto analysis,
**so that** I can monitor equipment reliability and identify recurring issues.

## Acceptance Criteria

AC-1: MTBF (Mean Time Between Failures) calculation
- Validation steps: Implement SQL views for calculating MTBF by equipment and component
- Pass condition: MTBF calculations are accurate and include rolling averages

AC-2: Pareto analysis for top故障部件
- Validation steps: Create SQL views for identifying top 10故障部件 distribution
- Pass condition: Pareto analysis correctly identifies most frequent故障部件

AC-3: Analytics SQL views creation
- Validation steps: Create materialized views for performance optimization
- Pass condition: Views provide efficient querying of analytics data

AC-4: Analytics API endpoints
- Validation steps: Create RESTful API endpoints for analytics data
- Pass condition: API returns formatted analytics data with filtering options

AC-5: Data visualization preparation
- Validation steps: Format analytics data for frontend visualization
- Pass condition: Data structured for easy consumption by charts and graphs

## Tasks / Subtasks

- [ ] Task 1: MTBF calculation logic (AC: 1)
  - [ ] Analyze data model for failure event tracking
  - [ ] Create SQL functions for MTBF calculation
  - [ ] Implement rolling average calculations
  - [ ] Add equipment and component grouping

- [ ] Task 2: Pareto analysis implementation (AC: 2)
  - [ ] Create SQL queries for symptom_ai frequency analysis
  - [ ] Implement top 10 ranking logic
  - [ ] Add percentage distribution calculations
  - [ ] Create cumulative percentage calculations

- [ ] Task 3: Analytics SQL views (AC: 3)
  - [ ] Create materialized views for performance
  - [ ] Implement view refresh scheduling
  - [ ] Add indexes for query optimization
  - [ ] Create view documentation and metadata

- [ ] Task 4: Analytics API endpoints (AC: 4)
  - [ ] Create `/api/analytics/mtbf` endpoint
  - [ ] Create `/api/analytics/pareto` endpoint
  - [ ] Add date range filtering
  - [ ] Implement equipment filtering
  - [ ] Create response serialization

- [ ] Task 5: Data visualization preparation (AC: 5)
  - [ ] Format data for time series charts
  - [ ] Structure data for bar charts and pie charts
  - [ ] Add metadata for chart configuration
  - [ ] Create data aggregation helpers

- [ ] Task 6: Testing and validation (AC: 1,2,3,4,5)
  - [ ] Create unit tests for calculation logic
  - [ ] Create integration tests for analytics endpoints
  - [ ] Validate calculations with sample data
  - [ ] Test performance with large datasets

## Dev Notes

### Previous Story Insights
- Story 3.1: FastAPI skeleton and database connection established [Source: docs/stories/3.1.FastAPI-Skeleton-Async-DB-Connection.md]
- Story 2.2: Data model understanding for analytics calculations [Source: docs/stories/2.2.Pydantic-Schema-Definition.md]
- Story 2.4: Performance considerations for large datasets [Source: docs/stories/2.4.Backfill-Tool-Historical-Data-Processing.md]

### Data Models
From architecture.md data model section:
- `notification_text` table with `noti_date`, `noti_issue_type`, `sys_eq_id` fields [Source: docs/architecture.md#5-数据模型-data-model]
- `ai_extracted_data` table with component and故障 information [Source: docs/architecture.md#5-数据模型-data-model]
- Field naming convention: `noti_` prefix for notification fields [Source: docs/architecture.md#5-数据模型-data-model]
- Trend code fields: `noti_trendcode_l1/l2/l3` for categorization [Source: docs/architecture.md#5-数据模型-data-model]

### API Specifications
From PRD requirements:
- MTBF (滚动平均) calculation for equipment reliability [Source: docs/prd.md#25-智能问答与看板-rag--analytics]
- Top 10故障部件 Pareto distribution analysis [Source: docs/prd.md#25-智能问答与看板-rag--analytics]
- Analytics endpoints for dashboard visualization [Source: docs/architecture.md#31-核心服务-running-in-wsl-2]
- Date range filtering for time-based analysis

### File Locations
Based on project structure:
- `src/backend/services/analytics_service.py` - Analytics service implementation
- `src/backend/services/mtbf_calculator.py` - MTBF calculation logic
- `src/backend/services/pareto_analyzer.py` - Pareto analysis logic
- `src/backend/db/analytics_views.sql` - SQL views definitions
- `src/backend/api/analytics.py` - Analytics API endpoints
- `tests/backend/services/test_analytics_service.py` - Analytics service tests
- `tests/backend/api/test_analytics.py` - Analytics API tests

### Testing Requirements
From architecture.md testing strategy:
- Unit tests for calculation algorithms
- Integration tests for analytics endpoints
- Performance tests for large dataset queries
- Data accuracy validation tests
- Edge case testing for date ranges and filters

### Technical Constraints
- PostgreSQL 18 on Windows host [Source: docs/architecture.md#32-数据存储-windows-host]
- Materialized views for performance optimization
- Async database queries for API responsiveness
- Efficient aggregation for large historical datasets
- Support for configurable date ranges and filters

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-28 | 1.0 | Initial story creation | Scrum Master |
