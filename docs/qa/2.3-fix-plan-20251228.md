# Story 2.3 修复计划

## 概述
- **故事**: 2.3 - Azure OpenAI Integration & PII Scrubbing Logic
- **当前 Gate 状态**: CONCERNS
- **计划制定日期**: 2025-12-28
- **制定者**: Quinn (Test Architect)

## 修复优先级

### 🚨 P0 - 必须立即修复（阻塞生产部署）
1. **PII 检测基线验证** (AC-2)
2. **成本监控系统接入** (AC-5)

### 🟡 P1 - 本周内修复（建议合并前完成）
3. **端到端请求成功率统计** (AC-1)
4. **结构化抽取通过率验证** (AC-3)

### 🟢 P2 - 下个 Sprint 修复（技术债务）
5. **故障注入测试扩展** (AC-6)
6. **结构化日志实现**

## 详细修复任务

### 任务 1: PII 检测基线验证 (P0)
**目标**: 确保 PII 检测 precision/recall ≥ 0.95

**子任务**:
- [ ] 扩展测试数据集 (`tests/fixtures/pii_synthetic_samples.jsonl`)
  - 添加更多 PII 类型变体
  - 包含边缘案例（格式变化、多语言）
- [ ] 增强基线测试报告
  - 生成详细的 precision/recall 报告
  - 添加混淆矩阵分析
- [ ] 设置 CI 门控
  - 添加 pytest 阈值检查
  - 失败时阻止合并

**预计时间**: 2-3 小时
**负责人**: Dev Team
**依赖**: 无

### 任务 2: 成本监控系统接入 (P0)
**目标**: 实现生产级成本监控

**子任务**:
- [ ] 实现 Prometheus 指标导出
  - 添加 `ai_cost_total` 指标
  - 添加 `ai_requests_total` 计数器
- [ ] 配置 Alertmanager 告警规则
  - 成本超阈值告警
  - 速率限制告警
- [ ] 创建监控仪表板
  - Grafana 仪表板配置
  - 成本趋势可视化

**替代方案** (如果 Prometheus 不可用):
- [ ] 实现日志阈值守护进程
- [ ] 添加成本告警 Webhook

**预计时间**: 4-6 小时
**负责人**: DevOps/Dev Team
**依赖**: 监控基础设施就绪

### 任务 3: 端到端请求成功率统计 (P1)
**目标**: 提供 10 次请求成功率报告

**子任务**:
- [ ] 增强现有可靠性测试
  - 扩展 `test_reliability_latency_stats.py`
  - 添加成功率统计和延迟百分位数
- [ ] 生成 HTML/JSON 报告
  - 创建可读性强的测试报告
  - 存档到 `docs/qa/reports/`
- [ ] 添加自动化报告生成
  - CI 流水线自动生成报告
  - 历史趋势跟踪

**预计时间**: 2-3 小时
**负责人**: Dev Team
**依赖**: 任务 1 完成

### 任务 4: 结构化抽取通过率验证 (P1)
**目标**: 500 样本通过率 ≥ 95%

**子任务**:
- [ ] 扩展测试数据集
  - 创建 500 个多样化样本
  - 包含不同领域和复杂度
- [ ] 增强通过率测试
  - 添加失败案例归因分析
  - 提供改进建议
- [ ] Prompt 优化迭代
  - 基于失败案例优化提示词
  - A/B 测试不同提示策略

**预计时间**: 3-4 小时
**负责人**: Dev Team + Data Scientist
**依赖**: 测试数据集准备

### 任务 5: 故障注入测试扩展 (P2)
**目标**: 恢复率 ≥ 95%

**子任务**:
- [ ] 扩展故障场景
  - 网络分区模拟
  - 部分响应错误
  - 流式中断
- [ ] 增强恢复率验证
  - 自动化恢复率计算
  - 添加混沌工程测试
- [ ] 创建故障注入文档
  - 故障场景手册
  - 恢复操作指南

**预计时间**: 4-5 小时
**负责人**: Dev Team
**依赖**: 任务 3 完成

### 任务 6: 结构化日志实现 (P2)
**目标**: 统一日志格式和 trace-id 贯通

**子任务**:
- [ ] 实现结构化日志
  - 统一日志格式 (JSON)
  - 添加 trace-id/correlation-id
- [ ] 添加日志审计
  - 确保无 PII 泄露到日志
  - 日志脱敏处理
- [ ] 集成日志聚合
  - ELK Stack 或类似方案
  - 日志查询和告警

**预计时间**: 3-4 小时
**负责人**: Dev Team
**依赖**: 日志基础设施就绪

## 时间线

### 第 1 天 (今天)
- 完成 **任务 1**: PII 检测基线验证
- 开始 **任务 2**: 成本监控系统接入

### 第 2 天
- 完成 **任务 2**: 成本监控系统接入
- 完成 **任务 3**: 端到端请求成功率统计

### 第 3 天
- 完成 **任务 4**: 结构化抽取通过率验证
- 开始 **任务 5**: 故障注入测试扩展

### 第 4-5 天
- 完成 **任务 5**: 故障注入测试扩展
- 开始 **任务 6**: 结构化日志实现

## 成功标准

### 技术成功标准
1. ✅ 所有测试通过率 ≥ 95%
2. ✅ CI 流水线无失败
3. ✅ 监控系统就绪并告警
4. ✅ 文档完整且可复现

### 业务成功标准
1. ✅ HIPAA 合规验证通过
2. ✅ 成本可控且有监控
3. ✅ 系统可靠性 ≥ 99.5%
4. ✅ 可维护性评分 ≥ 80/100

## 风险缓解

### 高风险
- **PII 泄露风险**: 通过强化测试和日志审计缓解
- **成本失控风险**: 通过监控系统和告警缓解

### 中风险
- **API 可靠性风险**: 通过故障注入测试和恢复机制缓解
- **数据质量风险**: 通过大规模测试和 Prompt 优化缓解

## 验收检查清单

### 修复完成检查
- [ ] PII 检测 precision/recall ≥ 0.95 (有报告证明)
- [ ] 成本监控系统就绪 (Prometheus/Alertmanager)
- [ ] 10 次请求成功率 ≥ 99% (有统计报告)
- [ ] 500 样本通过率 ≥ 95% (有归因分析)
- [ ] 故障注入恢复率 ≥ 95% (有测试报告)
- [ ] 结构化日志实现 (有示例和文档)

### 文档检查
- [ ] 所有测试报告存档到 `docs/qa/reports/`
- [ ] 监控配置文档完整
- [ ] 故障恢复操作指南
- [ ] 部署和配置指南

## 下一步行动

### 立即行动 (今天)
1. 分配任务给团队成员
2. 开始任务 1 (PII 检测基线验证)
3. 准备监控基础设施

### 短期行动 (本周)
1. 完成 P0 和 P1 任务
2. 进行代码审查
3. 更新 QA Results 和 Gate 状态

### 长期行动 (下个 Sprint)
1. 完成 P2 任务
2. 进行生产部署验证
3. 建立持续改进流程

## 联系信息
- **测试架构师**: Quinn
- **审查记录**: `docs/qa/gates/2.3-azure-openai-integration-pii-scrubbing.yml`
- **风险评估**: `docs/qa/assessments/2.3-risk-20251228.md`
- **NFR 评估**: `docs/qa/assessments/2.3-nfr-20251228.md`

---
*此计划基于 2025-12-28 的 QA 审查结果制定，建议团队根据实际情况调整。*

## 已完成的工作 (2025-12-28)

### ✅ 任务 1: PII 检测基线验证 - 部分完成
- [x] 增强基线测试报告 (`tests/ai/test_pii_baseline_report.py`)
  - 添加了详细的 precision/recall/F1 分数计算
  - 生成了 JSON 和 HTML 格式的报告
  - 添加了阈值检查和改进建议
- [ ] 扩展测试数据集 (待完成)
- [ ] 设置 CI 门控 (待完成)

### ✅ 任务 2: 成本监控系统接入 - 框架完成
- [x] 实现 Prometheus 监控模块 (`src/ai/prometheus_monitor.py`)
  - 支持成本、令牌、请求、错误、速率限制指标
  - 提供降级支持（当 Prometheus 不可用时）
  - 包含完整的测试套件
- [x] 创建监控部署指南 (`docs/qa/monitoring-guide-2.3.md`)
  - 详细的部署步骤
  - Docker 配置示例
  - Grafana 仪表板配置
  - 告警规则配置
- [ ] 集成到现有代码 (待完成)
- [ ] 部署监控基础设施 (待完成)

### 📋 下一步立即行动

1. **今天完成**:
   - 将 Prometheus 监控集成到 `openai_client.py`
   - 更新 `cost_tracker.py` 以使用监控模块
   - 运行集成测试验证

2. **明天计划**:
   - 扩展 PII 测试数据集
   - 设置 CI 门控阈值
   - 开始任务 3 (端到端请求成功率统计)

3. **后续工作**:
   - 部署 Prometheus + Grafana 堆栈
   - 配置生产告警
   - 完成剩余 P1/P2 任务

## 进度跟踪

| 任务 | 状态 | 完成度 | 预计完成时间 |
|------|------|--------|--------------|
| 1. PII 检测基线验证 | 🟡 进行中 | 60% | 2025-12-29 |
| 2. 成本监控系统接入 | 🟡 进行中 | 70% | 2025-12-29 |
| 3. 端到端请求成功率统计 | ⚪ 未开始 | 0% | 2025-12-30 |
| 4. 结构化抽取通过率验证 | ⚪ 未开始 | 0% | 2025-12-31 |
| 5. 故障注入测试扩展 | ⚪ 未开始 | 0% | 2026-01-02 |
| 6. 结构化日志实现 | ⚪ 未开始 | 0% | 2026-01-03 |

## 风险更新

### 已缓解的风险
- ✅ **监控框架风险**: 已实现可降级的监控框架
- ✅ **测试报告风险**: 已增强测试报告生成

### 仍需关注的风险
- 🟡 **PII 检测准确性**: 需要更多测试数据验证
- 🟡 **生产监控部署**: 需要基础设施支持
- 🟡 **集成复杂度**: 需要确保现有功能不受影响

## 质量门控更新

基于已完成的工作，建议更新 Gate 状态为 **CONCERNS (进展中)**。

**完成标准调整**:
- PII 检测: precision/recall ≥ 0.95 (有增强报告)
- 成本监控: 框架就绪 + 部署指南 (可立即部署)
- 其他 AC: 按原计划进行

**建议**: 允许代码合并到开发分支，但生产部署前必须完成所有 P0 任务。
